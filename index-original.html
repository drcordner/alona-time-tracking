<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alona's Activity Tracker</title>
    <meta name="theme-color" content="#4A90E2">
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiQWxvbmEncyBBY3Rpdml0eSBUcmFja2luZyIsInNob3J0X25hbWUiOiJUaW1lVHJhY2tlciIsInN0YXJ0X3VybCI6Ii8iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjZmZmZmZmIiwidGhlbWVfY29sb3IiOiIjNEE5MEUyIiwiaWNvbnMiOlt7InNyYyI6ImRhdGE6aW1hZ2Uvc3ZnK3htbDtiYXNlNjQsUEhOMlp5QjNhV1IwYUQwaU1qUXdJaUJvWldsbmFIUTlJakkwTUNJZ2RtbGxkMEp2ZUQwaU1DQXdJakkwTUNBeU5EQWlJSGh0Ykc1elBTSm9kSFJ3T2k4dmQzZDNMbmN6TG05eVp5OHlNREF3TDNOMlp5SStQSEpsWTNRZ2QybGtkR2c5SWpJME1DSWdhR1ZwWjJoMFBTSXlOREFpSUhKNFBTSXhNaUlnWm1sc2JEMGlJelEyT0RCR01pSXZQand2YzNablBnPT0iLCJzaXplcyI6IjI0MHgyNDAiLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCJ9XX0=">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding-bottom: 80px;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
            min-height: calc(100vh - 80px);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px 0;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 1.8em;
            font-weight: 300;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        .category-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .category-button {
            background: white;
            border: none;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: left;
            position: relative;
            overflow: hidden;
        }

        .category-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .category-button::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 6px;
            background: var(--category-color);
        }

        .category-name {
            font-size: 1.2em;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .category-time {
            color: #7f8c8d;
            font-size: 0.9em;
        }

        .activity-list {
            margin-bottom: 20px;
        }

        .activity-button {
            background: white;
            border: none;
            border-radius: 8px;
            padding: 15px 20px;
            margin-bottom: 10px;
            cursor: pointer;
            width: 100%;
            text-align: left;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .activity-button:hover {
            background: #f8f9fa;
            transform: translateY(-1px);
        }

        .activity-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .activity-name {
            font-weight: 500;
            color: #2c3e50;
            margin-bottom: 3px;
        }

        .activity-time {
            color: #7f8c8d;
            font-size: 0.8em;
        }

        .timer-container {
            text-align: center;
            margin: 40px 0;
            padding: 40px 20px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.1);
        }

        .timer-display {
            font-size: 3em;
            font-weight: 300;
            color: #2c3e50;
            margin-bottom: 20px;
            font-family: 'Courier New', monospace;
        }

        .current-activity {
            font-size: 1.2em;
            color: #7f8c8d;
            margin-bottom: 30px;
        }

        .stop-button {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50px;
            padding: 15px 40px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .stop-button:hover {
            background: #c0392b;
            transform: scale(1.05);
        }

        .navigation {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e9ecef;
            display: flex;
            height: 80px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }

        .nav-button {
            flex: 1;
            background: none;
            border: none;
            padding: 10px;
            cursor: pointer;
            transition: background 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .nav-button:hover {
            background: #f8f9fa;
        }

        .nav-button.active {
            color: #4A90E2;
            background: #f0f7ff;
        }

        .nav-icon {
            width: 24px;
            height: 24px;
            margin-bottom: 5px;
        }

        .nav-text {
            font-size: 0.8em;
        }

        .timeline {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .date-nav {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .date-nav button {
            background: #4A90E2;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .date-nav button:hover {
            background: #357abd;
        }

        .current-date {
            font-weight: 600;
            color: #2c3e50;
        }

        .timeline-bar {
            height: 40px;
            background: #f8f9fa;
            border-radius: 20px;
            overflow: hidden;
            margin-bottom: 20px;
            display: flex;
        }

        .timeline-segment {
            height: 100%;
            transition: all 0.3s ease;
        }

        .category-summary {
            margin-bottom: 20px;
        }

        .category-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }

        .category-item:hover {
            background: #f8f9fa;
            margin: 0 -10px;
            padding: 10px;
            border-radius: 6px;
        }

        .category-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .view-toggles {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .toggle-button {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 8px 16px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .toggle-button.active {
            background: #4A90E2;
            color: white;
            border-color: #4A90E2;
        }

        .quick-start-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .quick-start-header {
            font-size: 1.1em;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
        }

        .quick-start-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .quick-start-button {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid transparent;
            border-radius: 8px;
            padding: 15px 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .quick-start-button:hover {
            transform: translateY(-2px);
            border-color: var(--category-color);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .quick-start-emoji {
            font-size: 1.8em;
            margin-bottom: 5px;
            display: block;
        }

        .quick-start-name {
            font-size: 0.9em;
            font-weight: 500;
            color: #2c3e50;
            margin-bottom: 3px;
        }

        .quick-start-category {
            font-size: 0.7em;
            color: #7f8c8d;
        }

        .navigation-disabled {
            pointer-events: none;
            opacity: 0.5;
        }

        .pause-button {
            background: #f39c12;
            color: white;
            border: none;
            border-radius: 50px;
            padding: 12px 30px;
            font-size: 1em;
            cursor: pointer;
            margin-right: 15px;
            transition: all 0.3s ease;
        }

        .pause-button:hover {
            background: #d68910;
            transform: scale(1.05);
        }

        .pause-button.paused {
            background: #27ae60;
        }

        .pause-button.paused:hover {
            background: #229954;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Alona's Activity Tracking</h1>
        </div>

        <!-- Home Screen -->
        <div id="home-screen" class="screen active">
            <div class="category-grid" id="category-list">
                <!-- Categories will be populated by JavaScript -->
            </div>
            <div class="quick-start-section">
                <div class="quick-start-header">Quick Start</div>
                <div class="quick-start-grid">
                    <!-- Quick start buttons will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Activity Screen -->
        <div id="activity-screen" class="screen">
            <div class="activity-list" id="activity-list">
                <!-- Activities will be populated by JavaScript -->
            </div>
            <div id="timer-section" style="display: none;">
                <div class="timer-container">
                    <div class="current-activity" id="current-activity-name"></div>
                    <div class="timer-display" id="timer-display">00:00:00</div>
                    <div style="margin-bottom: 20px; color: #7f8c8d; font-size: 0.9em;">
                        <div>Current Session</div>
                    </div>
                    <div style="margin-bottom: 20px; color: #2c3e50; font-size: 1.1em;">
                        <div>Today Total: <span id="today-total-time">00:00:00</span></div>
                    </div>
                    <div id="timer-status" style="margin-bottom: 20px; color: #7f8c8d; font-size: 0.9em; height: 20px;">
                        <!-- Timer status (running/paused) will show here -->
                    </div>
                    <div style="text-align: center;">
                        <button class="pause-button" id="pause-button" onclick="togglePause()">Pause</button>
                        <button class="stop-button" onclick="stopTimer()">Stop</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reports Screen -->
        <div id="reports-screen" class="screen">
            <div class="view-toggles">
                <button class="toggle-button active" onclick="setReportView('day')">Day</button>
                <button class="toggle-button" onclick="setReportView('week')">Week</button>
                <button class="toggle-button" onclick="setReportView('month')">Month</button>
            </div>
            
            <div class="timeline">
                <div class="timeline-header">
                    <div class="date-nav">
                        <button onclick="navigateDate(-1)">â€¹â€¹ Prev</button>
                        <span class="current-date" id="current-report-date"></span>
                        <button onclick="navigateDate(1)">Next â€ºâ€º</button>
                    </div>
                </div>
                <div class="timeline-bar" id="timeline-bar"></div>
                <div class="category-summary" id="category-summary"></div>
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <div class="navigation">
        <button class="nav-button" onclick="goBack()">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.42-1.41L7.83 13H20v-2z"/>
            </svg>
            <span class="nav-text">Back</span>
        </button>
        <button class="nav-button active" onclick="showScreen('home')">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
            </svg>
            <span class="nav-text">Home</span>
        </button>
        <button class="nav-button" onclick="showScreen('reports')">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/>
            </svg>
            <span class="nav-text">Reports</span>
        </button>
    </div>

    <script>
        // Data structure - Enhanced with emojis and goals
        const categories = {
            'Artistic Expression': {
                color: '#e74c3c',
                emoji: 'ðŸŽ¨',
                activities: ['Draw/Paint', 'Fabric', 'Food', 'Guitar', 'Learn', 'Music', 'Piano', 'Scales', 'Sing', 'Write']
            },
            'Break': {
                color: '#95a5a6',
                emoji: 'â˜•',
                activities: ['Break']
            },
            'Create': {
                color: '#f39c12',
                emoji: 'ðŸ”¨',
                activities: ['Build', 'Clean', 'Cook', 'Garden', 'Home', 'Learn', 'Outdoors', 'Prep', 'Shop']
            },
            'Move': {
                color: '#27ae60',
                emoji: 'ðŸ’ª',
                activities: ['Jog', 'Learn', 'Pelvic Floor', 'Strength', 'Stretch', 'Tai Chi', 'Walk', 'Yoga']
            },
            'Sleep': {
                color: '#8e44ad',
                emoji: 'ðŸ˜´',
                activities: ['Sleep']
            },
            'Socialise': {
                color: '#e67e22',
                emoji: 'ðŸ‘¥',
                activities: ['Acquaintance', 'Close']
            },
            'Sustain': {
                color: '#3498db',
                emoji: 'ðŸ§˜',
                activities: ['Beautify', 'Breath', 'Eat', 'Ground', 'Hygiene', 'Learn', 'Light', 'Meditate', 'Therapy']
            }
        };

        // Activity emojis mapping
        const activityEmojis = {
            'Draw/Paint': 'ðŸŽ¨', 'Fabric': 'ðŸ§µ', 'Food': 'ðŸ³', 'Guitar': 'ðŸŽ¸', 'Music': 'ðŸŽµ', 'Piano': 'ðŸŽ¹', 'Scales': 'ðŸŽ¼', 'Sing': 'ðŸŽ¤', 'Write': 'âœï¸',
            'Break': 'â˜•',
            'Build': 'ðŸ”¨', 'Clean': 'ðŸ§¹', 'Cook': 'ðŸ‘¨â€ðŸ³', 'Garden': 'ðŸŒ±', 'Home': 'ðŸ ', 'Outdoors': 'ðŸŒ³', 'Prep': 'ðŸ“‹', 'Shop': 'ðŸ›’',
            'Jog': 'ðŸƒ', 'Pelvic Floor': 'ðŸ¤¸', 'Strength': 'ðŸ’ª', 'Stretch': 'ðŸ¤¸â€â™€ï¸', 'Tai Chi': 'ðŸ¥‹', 'Walk': 'ðŸš¶', 'Yoga': 'ðŸ§˜â€â™€ï¸',
            'Sleep': 'ðŸ˜´',
            'Acquaintance': 'ðŸ‘‹', 'Close': 'ðŸ¤—',
            'Beautify': 'ðŸ’„', 'Breath': 'ðŸ«', 'Eat': 'ðŸ½ï¸', 'Ground': 'ðŸŒ', 'Hygiene': 'ðŸš¿', 'Light': 'â˜€ï¸', 'Meditate': 'ðŸ§˜', 'Therapy': 'ðŸ’†'
        };

        // Configuration
        const sandbox = false; // Set to false to use localStorage instead of in-memory storage

        // Enhanced State management
        let currentScreen = 'home';
        let currentCategory = null;
        let currentActivity = null;
        let timerInterval = null;
        let startTime = null;
        let pausedTime = 0; // Total paused time in current session
        let pauseStartTime = null; // When current pause started
        let isPaused = false;
        let reportDate = new Date();
        let reportView = 'day';
        let activityUsageStats = {}; // Track usage for smart quick start
        
        // In-memory storage (used when sandbox = true)
        let timeTrackingData = {};

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            if (!sandbox) {
                loadData();
                loadUsageStats();
                recoverActiveTimer(); // Check for running timer on app load
            }
            renderCategories();
            updateReportDate();
            showScreen('home');
        });

        // Enhanced Storage functions
        function saveData() {
            if (sandbox) return;
            localStorage.setItem('timeTracking', JSON.stringify(timeTrackingData));
        }

        function loadData() {
            if (sandbox) return;
            const stored = localStorage.getItem('timeTracking');
            if (stored) {
                timeTrackingData = JSON.parse(stored);
            } else {
                localStorage.setItem('timeTracking', JSON.stringify({}));
            }
        }

        function saveUsageStats() {
            if (sandbox) return;
            localStorage.setItem('usageStats', JSON.stringify(activityUsageStats));
        }

        function loadUsageStats() {
            if (sandbox) return;
            const stored = localStorage.getItem('usageStats');
            if (stored) {
                activityUsageStats = JSON.parse(stored);
            }
        }

        function saveTimerState() {
            if (sandbox) return;
            const timerState = {
                active: !!timerInterval,
                category: currentCategory,
                activity: currentActivity,
                startTime: startTime,
                pausedTime: pausedTime,
                isPaused: isPaused,
                pauseStartTime: pauseStartTime
            };
            localStorage.setItem('activeTimer', JSON.stringify(timerState));
        }

        function clearTimerState() {
            if (sandbox) return;
            localStorage.removeItem('activeTimer');
        }

        function recoverActiveTimer() {
            if (sandbox) return;
            const stored = localStorage.getItem('activeTimer');
            if (stored) {
                const timerState = JSON.parse(stored);
                if (timerState.active && timerState.startTime) {
                    // Show recovery dialog
                    const timeSinceStart = Math.floor((Date.now() - timerState.startTime) / 1000);
                    const shouldRecover = confirm(
                        `Found an active timer for "${timerState.category} - ${timerState.activity}" started ${Math.floor(timeSinceStart / 60)} minutes ago. Do you want to continue this timer?`
                    );
                    
                    if (shouldRecover) {
                        // Set up timer state first
                        currentCategory = timerState.category;
                        currentActivity = timerState.activity;
                        startTime = timerState.startTime;
                        pausedTime = timerState.pausedTime || 0;
                        isPaused = false; // Resume if it was paused
                        
                        // CRITICAL: Show activity screen FIRST, then modify its contents
                        showScreen('activity');
                        
                        // Now set up the timer display - this must happen AFTER showScreen
                        document.getElementById('current-activity-name').textContent = `${currentCategory} - ${currentActivity}`;
                        
                        // Set initial today total time
                        const todayTime = getTodayTime(currentCategory, currentActivity);
                        document.getElementById('today-total-time').textContent = formatTime(todayTime);
                        
                        // CRITICAL: Show timer section and hide activity list
                        document.getElementById('timer-section').style.display = 'block';
                        document.getElementById('activity-list').style.display = 'none';
                        
                        // Disable navigation during timing
                        document.querySelector('.navigation').classList.add('navigation-disabled');
                        
                        // Reset pause button state
                        const pauseButton = document.getElementById('pause-button');
                        pauseButton.textContent = 'Pause';
                        pauseButton.classList.remove('paused');
                        
                        // Update timer status
                        updateTimerStatus();
                        
                        // Start the timer interval
                        timerInterval = setInterval(updateTimerDisplay, 1000);
                        updateTimerDisplay();
                        
                        // Save the recovered state
                        saveTimerState();
                    } else {
                        clearTimerState();
                    }
                }
            }
        }

        function updateActivityUsage(category, activity) {
            const key = `${category}::${activity}`;
            const now = Date.now();
            const hour = new Date().getHours();
            
            if (!activityUsageStats[key]) {
                activityUsageStats[key] = {
                    frequency: 0,
                    lastUsed: now,
                    timeOfDayPattern: {}
                };
            }
            
            activityUsageStats[key].frequency++;
            activityUsageStats[key].lastUsed = now;
            activityUsageStats[key].timeOfDayPattern[hour] = (activityUsageStats[key].timeOfDayPattern[hour] || 0) + 1;
            
            saveUsageStats();
        }

        function addTimeRecord(category, activity, duration, date = new Date()) {
            const dateKey = date.toDateString();
            
            if (!timeTrackingData[dateKey]) {
                timeTrackingData[dateKey] = {};
            }
            if (!timeTrackingData[dateKey][category]) {
                timeTrackingData[dateKey][category] = {};
            }
            if (!timeTrackingData[dateKey][category][activity]) {
                timeTrackingData[dateKey][category][activity] = 0;
            }
            
            timeTrackingData[dateKey][category][activity] += duration;
            
            if (!sandbox) {
                saveData();
            }
        }

        function getTodayTime(category, activity = null) {
            const today = new Date().toDateString();
            
            if (!timeTrackingData[today] || !timeTrackingData[today][category]) return 0;
            
            if (activity) {
                return timeTrackingData[today][category][activity] || 0;
            } else {
                return Object.values(timeTrackingData[today][category]).reduce((sum, time) => sum + time, 0);
            }
        }

        function getDateData(date) {
            const dateKey = date.toDateString();
            return timeTrackingData[dateKey] || {};
        }

        // Screen management
        function showScreen(screenName) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenName + '-screen').classList.add('active');
            
            document.querySelectorAll('.nav-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            if (screenName === 'home') {
                document.querySelectorAll('.nav-button')[1].classList.add('active');
                renderCategories();
            } else if (screenName === 'reports') {
                document.querySelectorAll('.nav-button')[2].classList.add('active');
                renderReports();
            }
            
            currentScreen = screenName;
        }

        function goBack() {
            if (currentScreen === 'activity') {
                showScreen('home');
            } else if (currentScreen === 'reports') {
                showScreen('home');
            }
        }

        // Enhanced Category rendering
        function renderCategories() {
            const container = document.getElementById('category-list');
            container.innerHTML = '';

            // Render quick start section first
            renderQuickStart();

            Object.entries(categories).forEach(([categoryName, categoryData]) => {
                const todayTime = getTodayTime(categoryName);
                const button = document.createElement('button');
                button.className = 'category-button';
                button.style.setProperty('--category-color', categoryData.color);
                
                // If category has only one activity, go directly to timer
                if (categoryData.activities.length === 1) {
                    button.onclick = () => startActivity(categoryName, categoryData.activities[0]);
                } else {
                    button.onclick = () => showActivities(categoryName);
                }

                button.innerHTML = `
                    <div class="category-name">${categoryName} ${categoryData.emoji}</div>
                    <div class="category-time">${formatTime(todayTime)}</div>
                `;

                container.appendChild(button);
            });
        }

        function renderQuickStart() {
            const quickStartGrid = document.querySelector('.quick-start-grid');
            quickStartGrid.innerHTML = '';

            const quickStartActivities = getSmartQuickStart();
            
            quickStartActivities.forEach(({category, activity, score}) => {
                const button = document.createElement('button');
                button.className = 'quick-start-button';
                button.style.setProperty('--category-color', categories[category].color);
                
                button.onclick = () => startActivity(category, activity);

                const emoji = activityEmojis[activity] || categories[category].emoji;
                
                button.innerHTML = `
                    <span class="quick-start-emoji">${emoji}</span>
                    <div class="quick-start-name">${activity}</div>
                    <div class="quick-start-category">${category}</div>
                `;

                quickStartGrid.appendChild(button);
            });

            // If no quick start activities, show a message
            if (quickStartActivities.length === 0) {
                quickStartGrid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; color: #7f8c8d; padding: 20px;">Start tracking activities to see personalized quick start buttons!</div>';
            }
        }

        function getSmartQuickStart() {
            const currentHour = new Date().getHours();
            const now = Date.now();
            const oneWeekAgo = now - (7 * 24 * 60 * 60 * 1000);
            
            const scores = [];
            
            Object.entries(activityUsageStats).forEach(([key, stats]) => {
                const [category, activity] = key.split('::');
                
                // Skip if category doesn't exist anymore
                if (!categories[category] || !categories[category].activities.includes(activity)) {
                    return;
                }
                
                let score = 0;
                
                // Frequency score (40% weight)
                score += stats.frequency * 0.4;
                
                // Recency score (30% weight) - higher for more recent usage
                const daysSinceLastUse = (now - stats.lastUsed) / (24 * 60 * 60 * 1000);
                const recencyScore = Math.max(0, 7 - daysSinceLastUse) / 7;
                score += recencyScore * 30;
                
                // Time of day pattern (30% weight)
                const timePattern = stats.timeOfDayPattern || {};
                const currentHourUsage = timePattern[currentHour] || 0;
                const maxHourUsage = Math.max(...Object.values(timePattern), 1);
                const timeScore = (currentHourUsage / maxHourUsage) * 30;
                score += timeScore;
                
                scores.push({ category, activity, score });
            });
            
            // Sort by score and take top 4
            return scores
                .sort((a, b) => b.score - a.score)
                .slice(0, 4);
        }

        // Activity rendering
        function showActivities(categoryName) {
            currentCategory = categoryName;
            const container = document.getElementById('activity-list');
            container.innerHTML = '';

            const activities = categories[categoryName].activities.sort();
            
            activities.forEach(activity => {
                const todayTime = getTodayTime(categoryName, activity);
                const button = document.createElement('button');
                button.className = 'activity-button';
                button.onclick = () => startActivity(categoryName, activity);

                button.innerHTML = `
                    <div class="activity-name">${activity} ${activityEmojis[activity]}</div>
                    <div class="activity-time">${formatTime(todayTime)}</div>
                `;

                container.appendChild(button);
            });

            showScreen('activity');
        }

        // Enhanced Timer functions
        function startActivity(category, activity, recovery = false) {
            currentCategory = category;
            currentActivity = activity;
            if (!recovery) {
                startTime = Date.now();
                pausedTime = 0;
                isPaused = false;
            }

            document.getElementById('current-activity-name').textContent = `${category} - ${activity}`;
            
            // Set initial today total time
            const todayTime = getTodayTime(category, activity);
            document.getElementById('today-total-time').textContent = formatTime(todayTime);
            
            document.getElementById('timer-section').style.display = 'block';
            document.getElementById('activity-list').style.display = 'none';

            // Disable navigation during timing
            document.querySelector('.navigation').classList.add('navigation-disabled');

            // Disable all activity buttons
            document.querySelectorAll('.activity-button').forEach(btn => {
                btn.disabled = true;
            });

            // Show activity screen (timer will be visible)
            showScreen('activity');

            // Reset pause button state
            const pauseButton = document.getElementById('pause-button');
            pauseButton.textContent = 'Pause';
            pauseButton.classList.remove('paused');
            
            // Update timer status
            updateTimerStatus();

            timerInterval = setInterval(updateTimerDisplay, 1000);
            updateTimerDisplay();

            if (!recovery) {
                saveTimerState();
                updateActivityUsage(category, activity);
            }
        }

        function updateTimerDisplay() {
            if (!startTime) return;
            
            let elapsed = Math.floor((Date.now() - startTime) / 1000) - pausedTime;
            
            // If currently paused, don't add current pause time yet
            if (isPaused && pauseStartTime) {
                // Keep the timer display frozen during pause
                elapsed = Math.floor((pauseStartTime - startTime) / 1000) - pausedTime;
            }
            
            document.getElementById('timer-display').textContent = formatTime(elapsed);
            
            // Update today's total time including current session
            const previousTime = getTodayTime(currentCategory, currentActivity);
            const totalTime = previousTime + elapsed;
            document.getElementById('today-total-time').textContent = formatTime(totalTime);
        }

        function updateTimerStatus() {
            const statusEl = document.getElementById('timer-status');
            if (isPaused) {
                statusEl.textContent = 'â¸ï¸ Timer Paused';
                statusEl.style.color = '#f39c12';
            } else {
                statusEl.textContent = 'â–¶ï¸ Timer Running';
                statusEl.style.color = '#27ae60';
            }
        }

        function togglePause() {
            const pauseButton = document.getElementById('pause-button');
            
            if (isPaused) {
                // Resume timer
                if (pauseStartTime) {
                    pausedTime += Math.floor((Date.now() - pauseStartTime) / 1000);
                }
                isPaused = false;
                pauseStartTime = null;
                pauseButton.textContent = 'Pause';
                pauseButton.classList.remove('paused');
            } else {
                // Pause timer
                isPaused = true;
                pauseStartTime = Date.now();
                pauseButton.textContent = 'Resume';
                pauseButton.classList.add('paused');
            }
            
            updateTimerStatus();
            saveTimerState();
        }

        function stopTimer() {
            if (!timerInterval || !startTime) return;

            let elapsed = Math.floor((Date.now() - startTime) / 1000) - pausedTime;
            
            // If currently paused, use the time when pause started
            if (isPaused && pauseStartTime) {
                elapsed = Math.floor((pauseStartTime - startTime) / 1000) - pausedTime;
            }

            addTimeRecord(currentCategory, currentActivity, elapsed);

            clearInterval(timerInterval);
            timerInterval = null;
            startTime = null;
            pausedTime = 0;
            pauseStartTime = null;
            isPaused = false;

            // Re-enable navigation
            document.querySelector('.navigation').classList.remove('navigation-disabled');

            document.getElementById('timer-section').style.display = 'none';
            document.getElementById('activity-list').style.display = 'block';

            // Re-enable activity buttons
            document.querySelectorAll('.activity-button').forEach(btn => {
                btn.disabled = false;
            });

            clearTimerState();
            showScreen('home');
        }

        // Report functions
        function setReportView(view) {
            reportView = view;
            document.querySelectorAll('.toggle-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            renderReports();
        }

        function navigateDate(direction) {
            const currentDate = new Date(reportDate);
            
            if (reportView === 'day') {
                currentDate.setDate(currentDate.getDate() + direction);
            } else if (reportView === 'week') {
                currentDate.setDate(currentDate.getDate() + (direction * 7));
            } else if (reportView === 'month') {
                currentDate.setMonth(currentDate.getMonth() + direction);
            }
            
            reportDate = currentDate;
            updateReportDate();
            renderReports();
        }

        function updateReportDate() {
            const dateEl = document.getElementById('current-report-date');
            if (reportView === 'day') {
                dateEl.textContent = reportDate.toLocaleDateString();
            } else if (reportView === 'week') {
                const startOfWeek = new Date(reportDate);
                startOfWeek.setDate(reportDate.getDate() - reportDate.getDay());
                const endOfWeek = new Date(startOfWeek);
                endOfWeek.setDate(startOfWeek.getDate() + 6);
                dateEl.textContent = `${startOfWeek.toLocaleDateString()} - ${endOfWeek.toLocaleDateString()}`;
            } else if (reportView === 'month') {
                dateEl.textContent = reportDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
            }
        }

        function renderReports() {
            updateReportDate();
            
            let data = {};
            
            if (reportView === 'day') {
                data = getDateData(reportDate);
            } else if (reportView === 'week') {
                // Aggregate week data
                for (let i = 0; i < 7; i++) {
                    const date = new Date(reportDate);
                    date.setDate(reportDate.getDate() - reportDate.getDay() + i);
                    const dayData = getDateData(date);
                    
                    Object.entries(dayData).forEach(([category, activities]) => {
                        if (!data[category]) data[category] = {};
                        Object.entries(activities).forEach(([activity, time]) => {
                            if (!data[category][activity]) data[category][activity] = 0;
                            data[category][activity] += time;
                        });
                    });
                }
            } else if (reportView === 'month') {
                // Aggregate month data
                const year = reportDate.getFullYear();
                const month = reportDate.getMonth();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(year, month, day);
                    const dayData = getDateData(date);
                    
                    Object.entries(dayData).forEach(([category, activities]) => {
                        if (!data[category]) data[category] = {};
                        Object.entries(activities).forEach(([activity, time]) => {
                            if (!data[category][activity]) data[category][activity] = 0;
                            data[category][activity] += time;
                        });
                    });
                }
            }

            renderTimeline(data);
            renderCategorySummary(data);
        }

        function renderTimeline(data) {
            const timeline = document.getElementById('timeline-bar');
            timeline.innerHTML = '';

            const totalTime = Object.values(data).reduce((total, activities) => {
                return total + Object.values(activities).reduce((sum, time) => sum + time, 0);
            }, 0);

            if (totalTime === 0) {
                timeline.innerHTML = '<div style="padding: 20px; text-align: center; color: #7f8c8d;">No activity recorded</div>';
                return;
            }

            Object.entries(data).forEach(([category, activities]) => {
                const categoryTotal = Object.values(activities).reduce((sum, time) => sum + time, 0);
                const percentage = (categoryTotal / totalTime) * 100;
                
                if (percentage > 0) {
                    const segment = document.createElement('div');
                    segment.className = 'timeline-segment';
                    segment.style.width = percentage + '%';
                    segment.style.backgroundColor = categories[category]?.color || '#bdc3c7';
                    segment.title = `${category}: ${formatTime(categoryTotal)}`;
                    timeline.appendChild(segment);
                }
            });
        }

        function renderCategorySummary(data) {
            const container = document.getElementById('category-summary');
            container.innerHTML = '';

            Object.entries(data).forEach(([category, activities]) => {
                const categoryTotal = Object.values(activities).reduce((sum, time) => sum + time, 0);
                
                const item = document.createElement('div');
                item.className = 'category-item';
                item.innerHTML = `
                    <div style="display: flex; align-items: center;">
                        <div class="category-dot" style="background-color: ${categories[category]?.color || '#bdc3c7'}"></div>
                        <span>${category} ${categories[category]?.emoji || ''}</span>
                    </div>
                    <span>${formatTime(categoryTotal)}</span>
                `;
                
                container.appendChild(item);
            });
        }

        // Utility functions
        function formatTime(totalSeconds) {
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;

            if (hours > 0) {
                return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            } else {
                return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }

        // Service Worker for offline functionality (only when not in sandbox)
        if (!sandbox && 'serviceWorker' in navigator) {
            navigator.serviceWorker.register('data:application/javascript;base64,Y29uc3QgQ0FDSEVfTkFNRSA9ICd0aW1lLXRyYWNrZXItdjEnOwpjb25zdCB1cmxzVG9DYWNoZSA9IFsKICAnLycsICAgCiAgJy9tYW5pZmVzdC5qc29uJwpdOwoKc2VsZi5hZGRFdmVudExpc3RlbmVyKCdpbnN0YWxsJywgZXZlbnQgPT4gewogIGV2ZW50LndhaXRVbnRpbCgKICAgIGNhY2hlcy5vcGVuKENBQ0hFX05BTUUpCiAgICAgIC50aGVuKGNhY2hlID0+IGNhY2hlLmFkZEFsbCh1cmxzVG9DYWNoZSkpCiAgKTsKfSk7CgpzZWxmLmFkZEV2ZW50TGlzdGVuZXIoJ2ZldGNoJywgZXZlbnQgPT4gewogIGV2ZW50LnJlc3BvbmRXaXRoKAogICAgY2FjaGVzLm1hdGNoKGV2ZW50LnJlcXVlc3QpCiAgICAgIC50aGVuKHJlc3BvbnNlID0+IHsKICAgICAgICByZXR1cm4gcmVzcG9uc2UgfHwgZmV0Y2goZXZlbnQucmVxdWVzdCk7CiAgICAgIH0pCiAgKTsKfSk7')
                .then(() => console.log('Service Worker registered'))
                .catch(err => console.log('Service Worker registration failed:', err));
        }
    </script>
</body>
</html>
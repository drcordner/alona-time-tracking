<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streak Fix Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            background: #f8f9fa;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 4px solid #4A90E2;
        }
        .test-result {
            background: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .test-error {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 4px;
            margin: 10px 0;
        }
        button {
            background: #4A90E2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #357abd;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>üîç Streak Calculation Fix Test</h1>
    
    <div class="test-section">
        <h2>Test Description</h2>
        <p>This test verifies that the streak calculation bug has been fixed. The bug was:</p>
        <ul>
            <li><strong>Problem:</strong> When checking if a goal was achieved on a past date, the function was calculating time for the current period instead of the historical period</li>
            <li><strong>Fix:</strong> Modified <code>getActualTimeForPeriod()</code> to properly calculate time for the specific date being checked</li>
        </ul>
    </div>

    <div class="test-section">
        <h2>Test Controls</h2>
        <button onclick="runBasicTest()">Run Basic Test</button>
        <button onclick="runStreakTest()">Run Streak Test</button>
        <button onclick="clearResults()">Clear Results</button>
    </div>

    <div id="test-results"></div>

    <script type="module">
        // Import the goals module to test
        import { Goals } from './js/goals.js';
        import { Storage } from './js/storage.js';

        // Mock storage for testing
        class MockStorage {
            constructor() {
                this.timeTrackingData = {};
            }
            
            getDateData(date) {
                const dateKey = date.toISOString().split('T')[0];
                return this.timeTrackingData[dateKey] || {};
            }
            
            getTodayTime(categoryName) {
                const today = new Date();
                const dayData = this.getDateData(today);
                if (dayData[categoryName]) {
                    return Object.values(dayData[categoryName]).reduce((sum, time) => sum + time, 0);
                }
                return 0;
            }
        }

        // Create test instance
        const mockStorage = new MockStorage();
        const mockGetCategories = () => ({
            'Test Category': {
                color: '#4A90E2',
                emoji: 'üß™',
                activities: ['Test Activity']
            }
        });
        const mockGetSetting = () => true;
        
        const goals = new Goals(mockStorage, mockGetCategories, mockGetSetting);
        goals.init();

        // Test functions
        window.runBasicTest = function() {
            const results = document.getElementById('test-results');
            results.innerHTML = '<h3>Basic Test Results</h3>';
            
            try {
                // Set up test data
                const testDate = new Date('2024-01-15');
                const testDateKey = testDate.toISOString().split('T')[0];
                
                // Add some test data for the specific date
                mockStorage.timeTrackingData[testDateKey] = {
                    'Test Category': {
                        'Test Activity': 3600 // 1 hour
                    }
                };
                
                // Set a goal
                goals.setGoal('Test Category', 'daily', 1800); // 30 minutes
                
                // Test the fix
                const progress = goals.debugStreakCalculation('Test Category', 'daily', testDate);
                
                if (progress && progress.achieved) {
                    results.innerHTML += '<div class="test-result">‚úÖ PASS: Goal correctly identified as achieved for the specific date</div>';
                } else {
                    results.innerHTML += '<div class="test-error">‚ùå FAIL: Goal not identified as achieved when it should be</div>';
                }
                
                results.innerHTML += `<pre>Test Date: ${testDate.toDateString()}
Goal Target: 30 minutes
Actual Time: ${progress ? Math.round(progress.actual / 60) : 0} minutes
Achieved: ${progress ? progress.achieved : 'Unknown'}</pre>`;
                
            } catch (error) {
                results.innerHTML += `<div class="test-error">‚ùå ERROR: ${error.message}</div>`;
            }
        };

        window.runStreakTest = function() {
            const results = document.getElementById('test-results');
            results.innerHTML = '<h3>Streak Test Results</h3>';
            
            try {
                // Set up consecutive days of data
                const baseDate = new Date('2024-01-10');
                
                // Add data for 5 consecutive days
                for (let i = 0; i < 5; i++) {
                    const testDate = new Date(baseDate);
                    testDate.setDate(baseDate.getDate() + i);
                    const testDateKey = testDate.toISOString().split('T')[0];
                    
                    mockStorage.timeTrackingData[testDateKey] = {
                        'Test Category': {
                            'Test Activity': 3600 // 1 hour each day
                        }
                    };
                }
                
                // Set a daily goal
                goals.setGoal('Test Category', 'daily', 1800); // 30 minutes
                
                // Test streak calculation
                const finalDate = new Date(baseDate);
                finalDate.setDate(baseDate.getDate() + 4); // 5th day
                
                goals.updateStreak('Test Category', 'daily', finalDate);
                const goal = goals.getGoal('Test Category', 'daily');
                
                if (goal && goal.streak === 5) {
                    results.innerHTML += '<div class="test-result">‚úÖ PASS: Streak correctly calculated as 5 days</div>';
                } else {
                    results.innerHTML += `<div class="test-error">‚ùå FAIL: Expected streak of 5, got ${goal ? goal.streak : 'undefined'}</div>`;
                }
                
                results.innerHTML += `<pre>Test Period: 5 consecutive days
Expected Streak: 5
Actual Streak: ${goal ? goal.streak : 'undefined'}</pre>`;
                
            } catch (error) {
                results.innerHTML += `<div class="test-error">‚ùå ERROR: ${error.message}</div>`;
            }
        };

        window.clearResults = function() {
            document.getElementById('test-results').innerHTML = '';
        };
    </script>
</body>
</html> 